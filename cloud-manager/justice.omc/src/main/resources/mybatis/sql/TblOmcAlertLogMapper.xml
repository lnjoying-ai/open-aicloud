<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lnjoying.justice.omc.db.mapper.TblOmcAlertLogMapper">
  <resultMap id="BaseResultMap" type="com.lnjoying.justice.omc.db.model.TblOmcAlertLog">
    <!--@mbg.generated-->
    <!--@Table tbl_omc_alert_log-->
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="alarm_id" jdbcType="VARCHAR" property="alarmId" />
    <result column="rule_id" jdbcType="VARCHAR" property="ruleId" />
    <result column="alert_group_id" jdbcType="VARCHAR" property="alertGroupId" />
    <result column="alert_type" jdbcType="INTEGER" property="alertType" />
    <result column="alert_status" jdbcType="INTEGER" property="alertStatus" />
    <result column="level" jdbcType="INTEGER" property="level" />
    <result column="way" jdbcType="INTEGER" property="way" />
    <result column="labels" jdbcType="OTHER" property="labels" typeHandler="com.lnjoying.justice.omc.handler.JsonbTypeHandler" />
    <result column="summary" jdbcType="VARCHAR" property="summary" />
    <result column="description" jdbcType="VARCHAR" property="description" />
    <result column="in_silence" jdbcType="BOOLEAN" property="inSilence" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="resource_type_id" jdbcType="VARCHAR" property="resourceTypeId" />
    <result column="resource_id" jdbcType="VARCHAR" property="resourceId" />
    <result column="bp_id" jdbcType="VARCHAR" property="bpId" />
    <result column="user_id" jdbcType="VARCHAR" property="userId" />
    <result column="unique_hash" jdbcType="INTEGER" property="uniqueHash" />
    <result column="first_alert_time" jdbcType="TIMESTAMP" property="firstAlertTime" />
    <result column="last_alert_time" jdbcType="TIMESTAMP" property="lastAlertTime" />
    <result column="times" jdbcType="INTEGER" property="times" />
    <result column="trigger_times" jdbcType="INTEGER" property="triggerTimes" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--@mbg.generated-->
    id, alarm_id, rule_id, alert_group_id, alert_type, alert_status, "level", way, labels, 
    summary, description, in_silence, create_time, update_time, resource_type_id, resource_id, 
    bp_id, user_id, unique_hash, first_alert_time, last_alert_time, times, trigger_times
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--@mbg.generated-->
    select 
    <include refid="Base_Column_List" />
    from tbl_omc_alert_log
    where id = #{id,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--@mbg.generated-->
    delete from tbl_omc_alert_log
    where id = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.lnjoying.justice.omc.db.model.TblOmcAlertLog">
    <!--@mbg.generated-->
    insert into tbl_omc_alert_log (id, alarm_id, rule_id, 
      alert_group_id, alert_type, alert_status, 
      "level", way, labels, 
      summary, description, in_silence, 
      create_time, update_time, resource_type_id, 
      resource_id, bp_id, user_id, 
      unique_hash, first_alert_time, last_alert_time, 
      times, trigger_times)
    values (#{id,jdbcType=VARCHAR}, #{alarmId,jdbcType=VARCHAR}, #{ruleId,jdbcType=VARCHAR}, 
      #{alertGroupId,jdbcType=VARCHAR}, #{alertType,jdbcType=INTEGER}, #{alertStatus,jdbcType=INTEGER}, 
      #{level,jdbcType=INTEGER}, #{way,jdbcType=INTEGER}, #{labels,jdbcType=OTHER,typeHandler=com.lnjoying.justice.omc.handler.JsonbTypeHandler}, 
      #{summary,jdbcType=VARCHAR}, #{description,jdbcType=VARCHAR}, #{inSilence,jdbcType=BOOLEAN}, 
      #{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP}, #{resourceTypeId,jdbcType=VARCHAR}, 
      #{resourceId,jdbcType=VARCHAR}, #{bpId,jdbcType=VARCHAR}, #{userId,jdbcType=VARCHAR}, 
      #{uniqueHash,jdbcType=INTEGER}, #{firstAlertTime,jdbcType=TIMESTAMP}, #{lastAlertTime,jdbcType=TIMESTAMP}, 
      #{times,jdbcType=INTEGER}, #{triggerTimes,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" parameterType="com.lnjoying.justice.omc.db.model.TblOmcAlertLog">
    <!--@mbg.generated-->
    insert into tbl_omc_alert_log
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null and id != ''">
        id,
      </if>
      <if test="alarmId != null and alarmId != ''">
        alarm_id,
      </if>
      <if test="ruleId != null and ruleId != ''">
        rule_id,
      </if>
      <if test="alertGroupId != null and alertGroupId != ''">
        alert_group_id,
      </if>
      <if test="alertType != null">
        alert_type,
      </if>
      <if test="alertStatus != null">
        alert_status,
      </if>
      <if test="level != null">
        "level",
      </if>
      <if test="way != null">
        way,
      </if>
      <if test="labels != null">
        labels,
      </if>
      <if test="summary != null and summary != ''">
        summary,
      </if>
      <if test="description != null and description != ''">
        description,
      </if>
      <if test="inSilence != null">
        in_silence,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="updateTime != null">
        update_time,
      </if>
      <if test="resourceTypeId != null and resourceTypeId != ''">
        resource_type_id,
      </if>
      <if test="resourceId != null and resourceId != ''">
        resource_id,
      </if>
      <if test="bpId != null and bpId != ''">
        bp_id,
      </if>
      <if test="userId != null and userId != ''">
        user_id,
      </if>
      <if test="uniqueHash != null">
        unique_hash,
      </if>
      <if test="firstAlertTime != null">
        first_alert_time,
      </if>
      <if test="lastAlertTime != null">
        last_alert_time,
      </if>
      <if test="times != null">
        times,
      </if>
      <if test="triggerTimes != null">
        trigger_times,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null and id != ''">
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="alarmId != null and alarmId != ''">
        #{alarmId,jdbcType=VARCHAR},
      </if>
      <if test="ruleId != null and ruleId != ''">
        #{ruleId,jdbcType=VARCHAR},
      </if>
      <if test="alertGroupId != null and alertGroupId != ''">
        #{alertGroupId,jdbcType=VARCHAR},
      </if>
      <if test="alertType != null">
        #{alertType,jdbcType=INTEGER},
      </if>
      <if test="alertStatus != null">
        #{alertStatus,jdbcType=INTEGER},
      </if>
      <if test="level != null">
        #{level,jdbcType=INTEGER},
      </if>
      <if test="way != null">
        #{way,jdbcType=INTEGER},
      </if>
      <if test="labels != null">
        #{labels,jdbcType=OTHER,typeHandler=com.lnjoying.justice.omc.handler.JsonbTypeHandler},
      </if>
      <if test="summary != null and summary != ''">
        #{summary,jdbcType=VARCHAR},
      </if>
      <if test="description != null and description != ''">
        #{description,jdbcType=VARCHAR},
      </if>
      <if test="inSilence != null">
        #{inSilence,jdbcType=BOOLEAN},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="resourceTypeId != null and resourceTypeId != ''">
        #{resourceTypeId,jdbcType=VARCHAR},
      </if>
      <if test="resourceId != null and resourceId != ''">
        #{resourceId,jdbcType=VARCHAR},
      </if>
      <if test="bpId != null and bpId != ''">
        #{bpId,jdbcType=VARCHAR},
      </if>
      <if test="userId != null and userId != ''">
        #{userId,jdbcType=VARCHAR},
      </if>
      <if test="uniqueHash != null">
        #{uniqueHash,jdbcType=INTEGER},
      </if>
      <if test="firstAlertTime != null">
        #{firstAlertTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastAlertTime != null">
        #{lastAlertTime,jdbcType=TIMESTAMP},
      </if>
      <if test="times != null">
        #{times,jdbcType=INTEGER},
      </if>
      <if test="triggerTimes != null">
        #{triggerTimes,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.lnjoying.justice.omc.db.model.TblOmcAlertLog">
    <!--@mbg.generated-->
    update tbl_omc_alert_log
    <set>
      <if test="alarmId != null and alarmId != ''">
        alarm_id = #{alarmId,jdbcType=VARCHAR},
      </if>
      <if test="ruleId != null and ruleId != ''">
        rule_id = #{ruleId,jdbcType=VARCHAR},
      </if>
      <if test="alertGroupId != null and alertGroupId != ''">
        alert_group_id = #{alertGroupId,jdbcType=VARCHAR},
      </if>
      <if test="alertType != null">
        alert_type = #{alertType,jdbcType=INTEGER},
      </if>
      <if test="alertStatus != null">
        alert_status = #{alertStatus,jdbcType=INTEGER},
      </if>
      <if test="level != null">
        "level" = #{level,jdbcType=INTEGER},
      </if>
      <if test="way != null">
        way = #{way,jdbcType=INTEGER},
      </if>
      <if test="labels != null">
        labels = #{labels,jdbcType=OTHER,typeHandler=com.lnjoying.justice.omc.handler.JsonbTypeHandler},
      </if>
      <if test="summary != null and summary != ''">
        summary = #{summary,jdbcType=VARCHAR},
      </if>
      <if test="description != null and description != ''">
        description = #{description,jdbcType=VARCHAR},
      </if>
      <if test="inSilence != null">
        in_silence = #{inSilence,jdbcType=BOOLEAN},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="resourceTypeId != null and resourceTypeId != ''">
        resource_type_id = #{resourceTypeId,jdbcType=VARCHAR},
      </if>
      <if test="resourceId != null and resourceId != ''">
        resource_id = #{resourceId,jdbcType=VARCHAR},
      </if>
      <if test="bpId != null and bpId != ''">
        bp_id = #{bpId,jdbcType=VARCHAR},
      </if>
      <if test="userId != null and userId != ''">
        user_id = #{userId,jdbcType=VARCHAR},
      </if>
      <if test="uniqueHash != null">
        unique_hash = #{uniqueHash,jdbcType=INTEGER},
      </if>
      <if test="firstAlertTime != null">
        first_alert_time = #{firstAlertTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastAlertTime != null">
        last_alert_time = #{lastAlertTime,jdbcType=TIMESTAMP},
      </if>
      <if test="times != null">
        times = #{times,jdbcType=INTEGER},
      </if>
      <if test="triggerTimes != null">
        trigger_times = #{triggerTimes,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.lnjoying.justice.omc.db.model.TblOmcAlertLog">
    <!--@mbg.generated-->
    update tbl_omc_alert_log
    set alarm_id = #{alarmId,jdbcType=VARCHAR},
      rule_id = #{ruleId,jdbcType=VARCHAR},
      alert_group_id = #{alertGroupId,jdbcType=VARCHAR},
      alert_type = #{alertType,jdbcType=INTEGER},
      alert_status = #{alertStatus,jdbcType=INTEGER},
      "level" = #{level,jdbcType=INTEGER},
      way = #{way,jdbcType=INTEGER},
      labels = #{labels,jdbcType=OTHER,typeHandler=com.lnjoying.justice.omc.handler.JsonbTypeHandler},
      summary = #{summary,jdbcType=VARCHAR},
      description = #{description,jdbcType=VARCHAR},
      in_silence = #{inSilence,jdbcType=BOOLEAN},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      resource_type_id = #{resourceTypeId,jdbcType=VARCHAR},
      resource_id = #{resourceId,jdbcType=VARCHAR},
      bp_id = #{bpId,jdbcType=VARCHAR},
      user_id = #{userId,jdbcType=VARCHAR},
      unique_hash = #{uniqueHash,jdbcType=INTEGER},
      first_alert_time = #{firstAlertTime,jdbcType=TIMESTAMP},
      last_alert_time = #{lastAlertTime,jdbcType=TIMESTAMP},
      times = #{times,jdbcType=INTEGER},
      trigger_times = #{triggerTimes,jdbcType=INTEGER}
    where id = #{id,jdbcType=VARCHAR}
  </update>

  <select id="selectAll" resultMap="BaseResultMap">
      WITH LatestProcesses AS (
      SELECT
      process.*,
      ROW_NUMBER() OVER (PARTITION BY process.alert_log_id ORDER BY process.update_time DESC) AS rn
      FROM
      (select * from tbl_omc_alert_log_process
        <where>
          <if test="processStatus != null and processStatus != ''">
            and process_status=#{processStatus,jdbcType=VARCHAR}
          </if>
          </where>
    ) process
      )
      SELECT
      log.*
      FROM
     (  select
        *
        from tbl_omc_alert_log
        <where>
          <if test="alertGroupId != null and alertGroupId != ''">
            and alert_group_id=#{alertGroupId,jdbcType=VARCHAR}
          </if>
          <if test="alertStatus != null">
            and alert_status=#{alertStatus,jdbcType=INTEGER}
          </if>
          <if test="level != null">
            and level=#{level,jdbcType=INTEGER}
          </if>
          <if test="resourceTypeId != null and resourceTypeId != ''">
            and resource_type_id=#{resourceTypeId,jdbcType=VARCHAR}
          </if>
          <if test="resourceId != null and resourceId != ''">
            and resource_id=#{resourceId,jdbcType=VARCHAR}
          </if>
          <if test="bpId != null and bpId != ''">
            and bp_id=#{bpId,jdbcType=VARCHAR}
          </if>
          <if test="userId != null and userId != ''">
            and user_id=#{userId,jdbcType=VARCHAR}
          </if>
        </where>) log
      LEFT JOIN
      LatestProcesses ON log.id = LatestProcesses.alert_log_id AND LatestProcesses.rn = 1
        order by log.update_time desc
    </select>

  <select id="selectAllByAlertStatus" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from tbl_omc_alert_log
        <where>
            <if test="alertStatus != null">
                and alert_status=#{alertStatus,jdbcType=INTEGER}
            </if>
        </where>
    </select>

  <select id="selectIdByAlertStatus" resultType="java.lang.String">
    SELECT
    t1.id
    FROM
    (select * from tbl_omc_alert_log
      <where>
        <if test="alertStatus != null">
          and alert_status=#{alertStatus,jdbcType=INTEGER}
        </if>
        <if test="true">
          and date_trunc('day', create_time) = current_date
        </if>
      </where>
    ) t1
    LEFT JOIN (
    select  DISTINCT ON (alert_log_id) alert_log_id,create_time, process_status from tbl_omc_alert_log_process
    where date_trunc('day', create_time) = current_date
    order by alert_log_id,create_time desc) t2
    ON t1.ID = t2.alert_log_id
    LEFT JOIN ( SELECT  DISTINCT ON (alert_log_id) alert_log_id,create_time, send_status FROM tbl_omc_alert_send_log   order by alert_log_id,create_time desc ) t3 ON t1.ID = t3.alert_log_id
    WHERE
    (t3.alert_log_id IS NULL or t3.send_status != 1) and ( t2.process_status is NULL or t2.process_status='unread')
  </select>

  <select id="selectAllByCreateTimeBetweenEqualAndLevel" resultType="java.lang.Integer">
    select
    count(*)
    from tbl_omc_alert_log
    <where>
      <if test="minCreateTime != null">
        and create_time <![CDATA[>=]]> #{minCreateTime,jdbcType=TIMESTAMP}
      </if>
      <if test="maxCreateTime != null">
        and create_time <![CDATA[<=]]> #{maxCreateTime,jdbcType=TIMESTAMP}
      </if>
      <if test="level != null">
        and "level"=#{level,jdbcType=INTEGER}
      </if>
      <if test="bpId != null and bpId != ''">
        and bp_id=#{bpId,jdbcType=VARCHAR}
      </if>
      <if test="userId != null and userId != ''">
        and user_id=#{userId,jdbcType=VARCHAR}
      </if>
      <if test="true">
        and alert_status !=2
      </if>
    </where>
  </select>

  <select id="selectByCreateTimeBetweenEqualAndLevel" resultType="com.lnjoying.justice.omc.domain.model.DailyAlertLog">
        select
          date_trunc('day', create_time) AS alertDay,
          level,
          COUNT(*) AS alertCount
        from tbl_omc_alert_log
        <where>
            <if test="minCreateTime != null">
                and create_time <![CDATA[>=]]> #{minCreateTime,jdbcType=TIMESTAMP}
            </if>
            <if test="maxCreateTime != null">
                and create_time <![CDATA[<]]> #{maxCreateTime,jdbcType=TIMESTAMP}
            </if>
            <if test="level != null">
                and "level"=#{level,jdbcType=INTEGER}
            </if>
          <if test="bpId != null and bpId != ''">
            and bp_id=#{bpId,jdbcType=VARCHAR}
          </if>
          <if test="userId != null and userId != ''">
            and user_id=#{userId,jdbcType=VARCHAR}
          </if>
        </where>
        GROUP BY
          alertDay,
          level
        order by alertDay asc
    </select>

  <select id="selectOneByUniqueHash" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from tbl_omc_alert_log
        <where>
            <if test="uniqueHash != null">
                and unique_hash=#{uniqueHash,jdbcType=INTEGER}
            </if>
        </where>
        order by create_time desc
        limit 1
    </select>
</mapper>